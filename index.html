<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Test</title>
</head>
<body style="background: #222; color: #fff; text-align: center; font-family: sans-serif;">
    <video id="v" autoplay playsinline style="width: 100%; max-height: 50vh; background: #000;"></video>
    <h3 id="st">Статус: Готов</h3>
    <button id="go" style="padding: 20px; width: 80%; font-size: 20px;">ПУСК</button>

    <script>
        const v = document.getElementById('v');
        const st = document.getElementById('st');
        const btn = document.getElementById('go');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(s => { v.srcObject = s; })
            .catch(e => { st.innerText = "Нет доступа к камере"; });

        btn.onclick = () => {
            btn.style.display = 'none';
            st.innerText = "Трансляция запущена...";
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            setInterval(async () => {
                canvas.width = v.videoWidth / 4; // Очень маленькое разрешение для теста
                canvas.height = v.videoHeight / 4;
                ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.3));
                
                try {
                    const res = await fetch('https://rating-tropical-changing-hansen.trycloudflare.com/stream', {
                        method: 'POST',
                        body: blob
                    });
                    st.innerText = "ОК: Кадр отправлен (" + new Date().toLocaleTimeString() + ")";
                    st.style.color = "#0f0";
                } catch (e) {
                    st.innerText = "ОШИБКА: " + e.message;
                    st.style.color = "#f00";
                }
            }, 500); // 2 кадра в секунду — для теста связи хватит
        };
    </script>
</body>
</html>
